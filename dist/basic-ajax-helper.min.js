class AjaxHelper{constructor(t={}){this.notify=t.notify||this.defaultNotify,this.csrfToken=t.csrfToken||document.querySelector('[name="_token"]')?.value||document.querySelector('meta[name="csrf-token"]')?.content,this.successSound=t.successSound||null,this.reloadDelay=t.reloadDelay||1500,this.afterReload=t.afterReload||null,this.init()}init(){this.bindClickReload(),this.bindCopy(),this.bindForms(),this.bindClickReloadGet(),this.bindClickReloadPost(),this.bindAjaxConfirm(),this.bindAjaxPModal(),this.bindBulkActions(),this.bindBulkExport(),this.bindAjaxModal(),this.bindSortable(),this.bindAjaxTabs(),this.bindAjaxPolling(),this.bindAutosave(),this.bindAutoLoad(),this.bindAutoLoadGet(),this.bindAutoLoadPost()}bindCopy(){$(document).on("click","[data-copy]",t=>{const e=$(t.currentTarget).attr("data-copy");this.copyToClipboard(e),this.notify("success","Kopyalandı","İçerik Kopyalandı")})}copyToClipboard(t){if(t=t.split(";").join("\n"),navigator.clipboard&&window.isSecureContext)navigator.clipboard.writeText(t);else{const e=$("<input>");$("body").append(e),e.val(t).select();try{document.execCommand("copy")}catch(t){}e.remove()}}bindForms(){$(document).on("submit","form[data-xhr]",t=>{t.preventDefault();const e=$(t.currentTarget);this.handleForm(e,t)})}handleForm(t,e){const a=t.attr("action"),o=t.attr("method")||"POST",n=new FormData(t[0]),i=t.data("callback"),s=t.data("loader"),r=t.data("submit-loader"),d=t.data("reload-target"),l=t.data("reload-url")||window.location.href,c=t.data("no-reload");let u;const m=()=>{u&&(u.removeData("loading"),u.html(u.data("text")))};if(r){if(u=$(e.originalEvent.submitter),u.data("text")||u.data("text",u.text()),u.data("loading"))return;u.data("loading",1),u.html('<i class="fas fa-spinner spin-me" style="font-size: 14px;margin: 0 auto"></i>')}const f=(e,a="success")=>{i&&("function"==typeof i?i(t,e,a):"string"==typeof i&&"function"==typeof window[i]&&window[i](t,e,a))};s&&f(null,"loader"),$.ajax({url:a,type:o.toUpperCase(),data:n,processData:!1,contentType:!1,xhr:()=>{let e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",e=>{if(e.lengthComputable){let a=e.loaded/e.total*100;document.dispatchEvent(new CustomEvent("ajax:progress",{detail:{form:t,percent:a}}))}},!1),e},success:e=>{m();try{f(e,"success")}catch(t){if("__stop__"===t)return;throw t}e.type&&e.message?(this.notify(e.type,e?.title,e.message),e.copy&&this.copyToClipboard(e.copy),"success"==e.type&&(d?$(d).load(l+" "+d+" > *",()=>{this.afterReload&&this.afterReload(d)}):(this.successSound&&this.successSound.play(),c||setTimeout(()=>window.location.reload(),e.delay||this.reloadDelay)))):this.notify(e.type,e?.title,e.message),document.dispatchEvent(new CustomEvent("ajax:success",{detail:{form:t,response:e}}))},error:e=>{m();try{f(e,"error")}catch(t){if("__stop__"===t)return;throw t}const a=e.responseJSON?.message||"İşlem sırasında hata oluştu.";this.notify("error","Hata",a),document.dispatchEvent(new CustomEvent("ajax:error",{detail:{form:t,error:e}}))}})}bindClickReloadPost(){$(document).on("click","[data-reload][data-reload-ptarget]",function(t){t.preventDefault();const e=$(this);if(e.attr("clicked"))return;e.attr("clicked",1);const a=e.html();e.html('<i class="fas fa-spinner spin-me" style="font-size:14px;margin:0 auto"></i>');const o=e.data("reload"),n=e.data("reload-ptarget"),i=e.data("target-main")||n;$.post(o,{_token:this.csrfToken||$('meta[name="csrf-token"]').attr("content")}).done(function(t){const e=$("<div>").html(t);$(n).html(e.find(i).html())}).fail(function(t){console.error("Reload POST failed",t)}).always(function(){e.html(a),e.removeAttr("clicked")})})}bindClickReloadGet(){$(document).on("click","[data-reload][data-reload-gtarget]",function(t){t.preventDefault();const e=$(this),a=parseInt(e.data("max-clicks")||0);let o=parseInt(e.data("click-count")||0),n="off"==$(this).data("loader");if(a&&o>=a)return;if(e.data("click-count",o+1),e.attr("data-old-width")||(e.attr("data-old-width",e.css("width")),e.css({width:e.attr("data-old-width"),"text-align":"center"})),e.attr("clicked"))return;e.attr("clicked",1);const i=e.html();n||e.html('<i class="fas fa-spinner spin-me" style="font-size:14px;margin:0 auto"></i>');const s=e.data("reload"),r=e.data("reload-gtarget"),d=e.data("target-main"),l=$("<div>"),c=()=>{e.html(i),e.removeAttr("clicked"),e.removeAttr("data-old-width"),e.css({width:"","text-align":""})};d?l.load(s+" "+d+" > *",function(t,e,a){"error"===e?console.error("Reload GET failed",a):$(r).html($(t)),c()}):l.load(s+" "+r+" > *",function(t,e,a){"error"===e?console.error("Reload GET failed",a):$(r).html(l.html()),c()})})}bindAjaxConfirm(){$(document).on("click","[data-ajax-confirm]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("ajax-confirm"),o=e.data("reload"),n=e.data("ajax-confirm-title")||"Emin misiniz?",i=e.data("ajax-confirm-text")||"Bu işlemi yapmak istediğinize emin misiniz?",s=e.data("ajax-confirm-icon")||"warning",r=e.data("ajax-confirm-button")||"Evet, devam et",d=e.data("ajax-cancel-button")||"İptal";Swal.fire({title:n,text:i,icon:s,showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:r,cancelButtonText:d}).then(t=>{t.isConfirmed&&$.ajax({url:a,type:"POST",data:{_token:this.csrfToken},success:t=>{void 0!==o&&setTimeout(()=>location.reload(),parseInt(o)),Swal.fire({title:t.title||"Başarılı",text:t.message||"",icon:t.type||"success"}),document.dispatchEvent(new CustomEvent("ajax:success",{detail:{element:e,response:t}}))},error:t=>{Swal.fire({title:"Hata!",text:t.responseJSON?.message||"İşlem başarısız oldu.",icon:"error"}),document.dispatchEvent(new CustomEvent("ajax:error",{detail:{element:e,error:t}}))}})})})}bindAjaxTabs(){$(document).on("click","[data-ajax-tab]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("url")||e.attr("href"),o=e.data("target"),n=e.data("reload")||!1;if(!a||!o)return void console.warn("Ajax Tab için url ve target gerekli.");const i=$(o);if(i.data("loaded")&&!n)return $("[data-ajax-tab]").removeClass("active"),e.addClass("active"),$(".ajax-tab-pane").removeClass("active show"),void i.addClass("active show");i.html('<div class="p-3 text-center text-muted">Yükleniyor...</div>'),$.get(a,t=>{i.html(t).data("loaded",!0),$("[data-ajax-tab]").removeClass("active"),e.addClass("active"),$(".ajax-tab-pane").removeClass("active show"),i.addClass("active show"),"function"==typeof this.afterReload&&this.afterReload(i)}).fail(t=>{i.html(`<div class="p-3 text-danger">Tab yüklenemedi: ${t.responseJSON?.message||"Hata"}</div>`)})})}bindAjaxPolling(){$("[data-poll]").each((t,e)=>{const a=$(e),o=a.data("url")||a.attr("href"),n=parseInt(a.data("poll"))||5e3;if(!o)return void console.warn("Polling için url gerekli.");const i=()=>{$.get(o,t=>{a.html(t),"function"==typeof this.afterReload&&this.afterReload(a)}).fail(t=>{console.error("Polling hatası:",t.responseText)})};i(),setInterval(i,n)})}bindBulkExport(){$(document).on("click","[data-bulk-export]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("bulk-export"),o=e.data("target")||'input[name="ids[]"]:checked';let n=[];if($(o).each(function(){n.push($(this).val())}),0===n.length)return void this.notify("warning","Uyarı","Hiçbir kayıt seçilmedi.");const i=$("<form>",{method:"POST",action:a});i.append($("<input>",{type:"hidden",name:"_token",value:this.csrfToken})),n.forEach(t=>{i.append($("<input>",{type:"hidden",name:"ids[]",value:t}))}),$("body").append(i),i.submit(),i.remove()})}bindBulkActions(){function t(t,e){0===e.length?$(t).hide():$(t).show()}$("[data-bulk-all]").on("click",function(){const t=$(this),e=t.data("target")||'[name="ids[]"]',a=$(e);if(!t.data("originalStates")){const e=a.map(function(){return $(this).prop("checked")}).get();t.data("originalStates",e)}if(t.data("toggled")){const e=t.data("originalStates");a.each(function(t){$(this).prop("checked",e[t]).trigger("change")}),t.data("toggled",!1)}else a.prop("checked",!0).trigger("change"),t.data("toggled",!0)}),$("[data-bulk-action]").each((e,a)=>{const o=$(a).data("toggle"),n=$(a).data("target")||'[name="ids[]"]:checked';if(!o)return;const i=[];$(n).each(function(){i.push($(this).val())}),$(n.replace(":checked","")).on("change",()=>{t(o,$(n))}),t(o,i)}),$(document).on("click","[data-bulk-action]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("bulk-action"),o=e.data("target")||'[name="ids[]"]:checked',n=[];$(o).each(function(){n.push($(this).val())}),0!==n.length?Swal.fire({title:"Emin misiniz?",text:`${n.length} kayıt üzerinde işlem yapılacak.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Evet, devam et",cancelButtonText:"İptal"}).then(t=>{t.isConfirmed&&$.ajax({url:a,type:"POST",data:{ids:n,_token:this.csrfToken},success:t=>{this.notify(t.type||"success",t.title||"Başarılı",t.message||""),t.reload&&setTimeout(()=>location.reload(),t.reload),document.dispatchEvent(new CustomEvent("ajax:success",{detail:{element:e,response:t}}))},error:t=>{this.notify("error","Hata!",t.responseJSON?.message||"İşlem başarısız oldu."),document.dispatchEvent(new CustomEvent("ajax:error",{detail:{element:e,error:t}}))}})}):this.notify("warning","Uyarı","Herhangi bir kayıt seçilmedi.")})}bindAjaxPModal(){$(document).on("click","[data-ajax-pmodal]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("ajax-pmodal");let o=e.data("values")||{};if("string"==typeof o)try{o=JSON.parse(o)}catch{o=o.split(";").reduce((t,e)=>{let[a,o]=e.split(":");return a&&o&&(t[a.trim()]=o.trim()),t},{})}o._token=this.csrfToken,$.ajax({url:a,type:"POST",data:o,success:t=>{let a=$("#ajaxHelperModal");const o=e.data("class")??"";if(0===a.length)a=$(`\n                        <div class="modal fade ${o}" id="ajaxHelperModal" tabindex="-1">\n                            <div class="modal-dialog modal-lg">\n                                <div class="modal-content"></div>\n                            </div>\n                        </div>\n                    `),$("body").append(a);else{const t=["modal","fade"],e=a.attr("class").split(" ").filter(e=>-1===t.indexOf(e));e.length>0&&a.removeClass(e.join(" ")),o&&a.addClass(o)}a.html(t),a.modal("show")},error:t=>{this.notify("error","Hata",t.responseJSON?.message||"Modal yüklenemedi.")}})})}bindAjaxModal(){$(document).on("click","[data-ajax-modal]",t=>{t.preventDefault();const e=$(t.currentTarget),a=e.data("ajax-modal");let o=e.data("values")||{};if("string"==typeof o)try{o=JSON.parse(o)}catch{o=o.split(";").reduce((t,e)=>{let[a,o]=e.split(":");return a&&o&&(t[a.trim()]=o.trim()),t},{})}$.get(a,o,t=>{let a=$("#ajaxHelperModal");const o=e.data("class")??"";if(0===a.length)a=$(`\n                        <div class="modal fade ${o}" id="ajaxHelperModal" tabindex="-1">\n                            <div class="modal-dialog modal-lg">\n                                <div class="modal-content"></div>\n                            </div>\n                        </div>\n                    `),$("body").append(a);else{const t=["modal","fade"],e=a.attr("class").split(" ").filter(e=>-1===t.indexOf(e));e.length>0&&a.removeClass(e.join(" ")),o&&a.addClass(o)}a.html(t),a.modal("show")}).fail(t=>{this.notify("error","Hata",t.responseJSON?.message||"Modal yüklenemedi.")})})}bindClickReload(){$("[data-reload][data-reload-target]").on("click",function(){$(this).attr("clicked")||($(this).attr("clicked",1),$($(this).data("reload-target")).load($(this).data("reload")+" "+$(this).data("reload-target")+" > *",()=>{$(this).removeAttr("clicked")}))})}bindSortable(){"undefined"!=typeof Sortable&&document.querySelectorAll("[data-sortable]").forEach(t=>{Sortable.create(t,{handle:t.dataset.handle||null,animation:150,onEnd:e=>{const a=Array.from(t.querySelectorAll("[data-id]")).map((t,e)=>({id:t.dataset.id,position:e+1}));$.ajax({url:t.dataset.sortable,method:"POST",data:{order:a,_token:this.csrfToken},success:e=>{this.notify(e.type||"success",e.title||"Başarılı",e.message||"Sıralama güncellendi.");const a=t.dataset.reloadTarget,o=t.dataset.reloadUrl||window.location.href;a&&$(a).load(o+" "+a+" > *",()=>{this.afterReload&&this.afterReload(a)})},error:t=>{this.notify("error","Hata",t.responseJSON?.message||"Sıralama kaydedilemedi.")}})}})})}bindAutoLoadGet(){$(document).ready(()=>{$("[data-autoload-get]").each((t,e)=>{const a=$(e),o=a.data("autoload-get"),n=a.data("reload-target"),i=a.data("reload-callback");let s=a.data("values")||{};if("string"==typeof s)try{s=JSON.parse(s)}catch{s=s.split(";").reduce((t,e)=>{let[a,o]=e.split(":");return a&&o&&(t[a.trim()]=o.trim()),t},{})}if(!o||!n)return void console.warn("AutoLoadGet için url ve reload-target gerekli.");const r=$(n),d=r.html();r.html('<div class="text-center p-3"><i class="fas fa-spinner spin-me"></i></div>');const l=(t,e="success")=>{i&&("function"==typeof i?i(a,t,e):"string"==typeof i&&"function"==typeof window[i]&&window[i](a,t,e))};$.get(o,s).done(t=>{r.html(t),l(t,"success"),"function"==typeof this.afterReload&&this.afterReload(n)}).fail(t=>{console.error("AutoLoadGet failed",t),r.html(d),l(t,"error")})})})}bindAutoLoadPost(){$(document).ready(()=>{$("[data-autoload-post]").each((t,e)=>{const a=$(e),o=a.data("autoload-post"),n=a.data("reload-target"),i=a.data("reload-callback");let s=a.data("values")||{};if("string"==typeof s)try{s=JSON.parse(s)}catch{s=s.split(";").reduce((t,e)=>{let[a,o]=e.split(":");return a&&o&&(t[a.trim()]=o.trim()),t},{})}if(s._token=this.csrfToken,!o||!n)return void console.warn("AutoLoadPost için url ve reload-target gerekli.");const r=$(n),d=r.html();r.html('<div class="text-center p-3"><i class="fas fa-spinner spin-me"></i></div>');const l=(t,e="success")=>{i&&("function"==typeof i?i(a,t,e):"string"==typeof i&&"function"==typeof window[i]&&window[i](a,t,e))};$.post(o,s).done(t=>{r.html(t),l(t,"success"),"function"==typeof this.afterReload&&this.afterReload(n)}).fail(t=>{console.error("AutoLoadPost failed",t),r.html(d),l(t,"error")})})})}bindAutoLoad(){$(document).ready(()=>{$("[data-autoload]").each((t,e)=>{const a=$(e),o=a.data("autoload"),n=a.data("reload-target"),i=a.data("reload-main")||n,s=a.data("reload-callback");if(!o||!n)return void console.warn("AutoLoad için url ve reload-target gerekli.");const r=$(n),d=r.html();r.html('<div class="text-center p-3"><i class="fas fa-spinner spin-me"></i></div>');const l=(t,e="success")=>{s&&("function"==typeof s?s(a,t,e):"string"==typeof s&&"function"==typeof window[s]&&window[s](a,t,e))},c=$("<div>");c.load(o+" "+i+" > *",function(t,e,a){"error"===e?(console.error("AutoLoad failed",a),r.html(d),l(a,"error")):(r.html(c.html()),l(t,"success"),"function"==typeof this.afterReload&&this.afterReload(n))}.bind(this))})})}bindAutosave(){let t={};$(document).on("input change","[data-autosave]",e=>{const a=$(e.currentTarget),o=a.closest("form"),n=o.attr("action"),i=o.attr("method")||"POST",s=a.attr("name"),r=a.val();t[s]&&clearTimeout(t[s]),t[s]=setTimeout(()=>{const t=new FormData;t.append(s,r),t.append("_token",this.csrfToken),$.ajax({url:n,type:i.toUpperCase(),data:t,processData:!1,contentType:!1,success:t=>{this.notify(t.type||"success",t.title||"Başarılı",t.message||"Sıralama güncellendi."),a.removeClass("is-invalid"),a.next(".invalid-feedback").remove()},error:t=>{if(422===t.status&&t.responseJSON?.errors){let e=t.responseJSON.errors[s]?.[0];e&&(a.addClass("is-invalid"),a.next(".invalid-feedback").length?a.next(".invalid-feedback").text(e):a.after(`<div class="invalid-feedback">${e}</div>`))}else this.notify("error","Hata","Değişiklik kaydedilemedi.")}})},500)})}defaultNotify(t,e,a){console.log(`[${t.toUpperCase()}] ${e}: ${a}`)}}
